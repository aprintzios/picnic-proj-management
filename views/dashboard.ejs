<%- include('./partials/header.ejs'); %>

    <%- include('./partials/nav.ejs'); %>
        <%- include('./partials/sidenav.ejs'); %>

            <div id="mainContent">

                <div id="filterSelect">
                    <form action="#">
                        <div>
                            Filter by Project

                            <%if(userProjects){%>
                                <%for (let i=0; i<userProjects.length; i++){%>

                                    <p>
                                        <label>
                                            <input class="projectFilter" name="<%=userProjects[i]._id%>"
                                                type="checkbox" />
                                            <span>
                                                <%=userProjects[i].name%>
                                            </span>
                                        </label>
                                    </p>
                                    <%}%>
                                        <%}%>

                        </div>
                        <div>
                            Filter by Status
                            <p>
                                <label>
                                    <input class="statusFilter" name="icebox" type="checkbox" />
                                    <span>Icebox</span>
                                </label>
                            </p>
                            <p>
                                <label>
                                    <input class="statusFilter" name="current" type="checkbox" />
                                    <span>Current/MVP</span>
                                </label>
                            </p>
                            <p>
                                <label>
                                    <input class="statusFilter" name="completed" type="checkbox" />
                                    <span>Completed</span>
                                </label>
                            </p>
                        </div>
                        <div>
                            <label for="dueAfter">Due after</label>
                            <input name="dueAfter" type="text" class="datepicker">
                        </div>

                        <div>
                            <label for="dueBefore">Due before</label>
                            <input name="dueBefore" type="text" class="datepicker">
                        </div>
                    </form>
                </div>

                <div id="taskContainer">

                    <table class="bordered" id="dashboardTaskTable">
                        <th id="taskHeader" class="">Task <img id="taskArrow" class="sortArrow" src="/images/down.png"
                                alt=""></th>
                        <th id="projectHeader" class="">Project <img id="projArrow" class="sortArrow" src="" alt="">
                        </th>
                        <th id="dueHeader" class="">Due <img id="dueArrow" class="sortArrow" src="" alt="">
                        </th>
                        <th id="statusHeader" class="">Status <img id="statusArrow" class="sortArrow" src="" alt="">
                        </th>
                        <th id="actionHeader" class="">Action </th>
                        <div id="subTaskContainer">

                        </div>
                        <%if (userTasks){%>
                            <%for (let i=0; i<userTasks.length; i++){%>
                                <tr>
                                    <td>
                                        <%=userTasks[i].name%>
                                    </td>
                                    <td>
                                        <a href="/projects/<%=userTasks[i].project._id%>">
                                            <%=userTasks[i].project.name%>
                                        </a>
                                    </td>
                                    <td>
                                        <%=userTasks[i].due.toDateString()%>
                                    </td>
                                    <td>
                                        <%=userTasks[i].status%>
                                    </td>
                                    <td>
                                        <a href="/projects/<%=userTasks[i].project._id%>/task/<%=userTasks[i]._id%>">
                                            <img class="updateImg" src="/images/edit.png" alt="editTask">
                                        </a>
                                        <form method="POST"
                                            action="/projects/<%=userTasks[i].project._id%>/task/<%=userTasks[i]._id%>/destroy?_method=DELETE">
                                            <button class="updateBtn"> <img class="updateImg" src="/images/delete.png"
                                                    alt="deleteTask">
                                            </button>
                                        </form>


                                    </td>
                                </tr>
                                <%}%>
                                    <%}%>


                    </table>

                    <div>
                        <canvas id="myChart" width="200" height="100"></canvas>

                    </div>
                </div>

            </div>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>

                let taskSortUp = true;
                let projSortUp = true;
                let dueSortUp = true;
                let statusSortUp = true;


                document.addEventListener('DOMContentLoaded', function () {
                    var elems = document.querySelectorAll('.sidenav');
                    var instances = M.Sidenav.init(elems);
                });
                document.addEventListener('DOMContentLoaded', function () {
                    var elems = document.querySelectorAll('select');
                    var instances = M.FormSelect.init(elems);
                });
                document.addEventListener('DOMContentLoaded', function () {
                    var elems = document.querySelectorAll('.datepicker');
                    var instances = M.Datepicker.init(elems);
                });

                //get header elements
                let taskEl = document.getElementById("taskHeader");
                let projectEl = document.getElementById("projectHeader");
                let dueEl = document.getElementById("dueHeader");
                let statusEl = document.getElementById("statusHeader");

                //get arrow elements

                let taskArrow = document.getElementById("taskArrow");
                let projArrow = document.getElementById("projArrow");
                let dueArrow = document.getElementById("dueArrow");
                let statusArrow = document.getElementById("statusArrow");


                taskEl.addEventListener("click", headerClick);
                projectEl.addEventListener("click", headerClick);
                dueEl.addEventListener("click", headerClick);
                statusEl.addEventListener("click", headerClick);

                taskArrow.addEventListener("click", arrowClick);
                projArrow.addEventListener("click", arrowClick);
                dueArrow.addEventListener("click", arrowClick);
                statusArrow.addEventListener("click", arrowClick);

                function headerClick(e) {
                    //determine which header was clicked
                    if (e.target.id == "taskHeader") {
                        console.log("task header");
                        if (taskSortUp == true) {
                            console.log("sort down");
                            taskSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            taskArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            taskSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort up
                            taskArrow.src = "/images/up.png"

                        }

                    } else if (e.target.id == "projectHeader") {
                        console.log("project header");
                        if (projSortUp == true) {
                            console.log("sort down");
                            projSortUp = false;
                            //clear all other arrows
                            taskArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            projArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            projSortUp = true;
                            //clear all other arrows
                            taskArrow.src = "";
                            dueArrow.src = "";
                            st2atusArrow.src = "";
                            //sort up
                            projArrow.src = "/images/up.png"

                        }
                    } else if (e.target.id == "dueHeader") {
                        console.log("due header");
                        if (dueSortUp == true) {
                            console.log("sort down");
                            dueSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            taskArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            dueArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            dueSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            taskArrow.src = "";
                            statusArrow.src = "";
                            //sort up
                            dueArrow.src = "/images/up.png"

                        }
                    } else if (e.target.id == "statusHeader") {
                        console.log("status header");
                        if (statusSortUp == true) {
                            console.log("sort down");
                            statusSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            taskArrow.src = "";
                            //sort down
                            statusArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            statusSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            taskArrow.src = "";
                            //sort up
                            statusArrow.src = "/images/up.png"

                        }
                    }

                }

                function arrowClick(e) {
                    //determine which header was clicked
                    if (e.target.id == "taskArrow") {
                        console.log("task arrow");
                        if (taskSortUp == true) {
                            console.log("sort down");
                            taskSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            taskArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            taskSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort up
                            taskArrow.src = "/images/up.png"

                        }

                    } else if (e.target.id == "projArrow") {
                        console.log("project arrow");
                        if (projSortUp == true) {
                            console.log("sort down");
                            projSortUp = false;
                            //clear all other arrows
                            taskArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            projArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            projSortUp = true;
                            //clear all other arrows
                            taskArrow.src = "";
                            dueArrow.src = "";
                            statusArrow.src = "";
                            //sort up
                            projArrow.src = "/images/up.png"

                        }
                    } else if (e.target.id == "dueArrow") {
                        console.log("due arrow");
                        if (dueSortUp == true) {
                            console.log("sort down");
                            dueSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            taskArrow.src = "";
                            statusArrow.src = "";
                            //sort down
                            dueArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            dueSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            taskArrow.src = "";
                            statusArrow.src = "";
                            //sort up
                            dueArrow.src = "/images/up.png"

                        }
                    } else if (e.target.id == "statusArrow") {
                        console.log("status arrow");
                        if (statusSortUp == true) {
                            console.log("sort down");
                            statusSortUp = false;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            taskArrow.src = "";
                            //sort down
                            statusArrow.src = "/images/down.png"
                        } else {
                            console.log("sort up");
                            statusSortUp = true;
                            //clear all other arrows
                            projArrow.src = "";
                            dueArrow.src = "";
                            taskArrow.src = "";
                            //sort up
                            statusArrow.src = "/images/up.png"

                        }
                    }

                }

                const ctx = document.getElementById('myChart').getContext('2d');
                let myChart;
                function renderGraph(icebox, current, completed) {
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Icebox', 'Current', 'Completed'],
                            datasets: [{
                                label: "",
                                data: [icebox, current, completed],
                                backgroundColor: [
                                    'rgba(206, 150, 251, 0.2)',
                                    'rgba(255, 143, 207, 0.2)',
                                    'rgba(0, 194, 186, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(206, 150, 251, 1)',
                                    'rgba(255, 143, 207, 1)',
                                    'rgba(0, 194, 186, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                }

                var projFilters = document.querySelectorAll(".projectFilter");
                var statusFilters = document.querySelectorAll(".statusFilter");

                let projChecked = [];
                let status = [];
                for (let i = 0; i < projFilters.length; i++) {
                    projFilters[i].addEventListener('change', function () {
                        if (this.checked) {
                            projChecked.push(this.name);
                            dashFilter(projChecked, status);
                        } else {
                            let projIndex;
                            for (let j = 0; j < projChecked.length; j++) {
                                if (projChecked[j] == this.name) {
                                    projChecked.splice(j, 1);
                                }
                            }
                            dashFilter(projChecked, status);
                        }
                    });
                }

                for (let i = 0; i < statusFilters.length; i++) {
                    statusFilters[i].addEventListener('change', function () {
                        if (this.checked) {
                            console.log("checked", this.name);
                            // projChecked.push(this.name);
                            // dashFilter(projChecked, status);
                        } else {
                            console.log("unchecked", this.name);
                            // let projIndex;
                            // for (let j=0; j<projChecked.length; j++){
                            //     if (projChecked[j] == this.name){
                            //         projChecked.splice(j, 1);
                            //     }
                            // }
                            // dashFilter(projChecked, status);
                        }
                    });
                }
                let icebox = 0;
                let current = 0;
                let completed = 0;
                async function dashFilter(projects) {
                    console.log("in filter tasks");
                    const endpoint = '/dashFilter';
                    let taskList = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            projects
                        })
                    }).then(res => res.json());

                    console.log("task list", taskList);

                    for (let i = 0; i < taskList.length; i++) {
                        if (taskList[i].status == 'icebox') {
                            icebox++;
                        } else if (taskList[i].status == 'current') {
                            current++;
                        } else {
                            completed++;
                        }
                    }
                    if (myChart) {
                        myChart.destroy();
                    }
                    renderGraph(icebox, current, completed);

                }

                filterTasks();
            </script>

            <!-- </body>

</html> -->

            <%- include('./partials/footer.ejs'); %>